<!DOCTYPE html>
<html lang="en-gb">
<head>
	<title>Grand Travel</title>
    <meta name="authors" content="Andrew Belcher, Luke Clayton, Robert Painter">
    <meta name="description" content="Grand Travel">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css?family=Muli" rel="stylesheet">
    <!-- adjustements to make directory structures more freindly with flask/jinja -->
    <link rel="stylesheet" href="/static/css/master.css">
    <link rel="stylesheet" href="/static/css/custom.css">
	<!--<link rel="stylesheet" href="{{ url_for('static', filename='css/master.css') }}">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/custom.css') }}">-->
    <script src="{{ url_for('static', filename='js/jquery-3.1.1.js') }}"></script>
    <script type="text/javascript">
	

	<!-- where we want to put jquery code that runs when the pages is loaded -->
	
	$(window).on('load', function(){

		// departure/arrival strings to check later on
		var departName = $('#departLocation').find(":selected").text();	
		var arriveName = $('#arriveLocation').find(":selected").text();	
		var passCnt = $('#passengerCnt').val();
		var dtime = $('#departTime').find(":selected").text()

		
		initPage(); // important that we run this every time the pages is loaded so we initialize things
		
		// modal jquery
		$('.enlarge').mouseenter(function(){
				$('.text',this).removeClass('hide');
			});
			
		$('.enlarge').mouseleave(function(){
				$('.text',this).removeClass('hide');
			});	

	
		// checks if departure options has changed and we then parse that information into the url for flask to deal with form rendering
		$("#departLocation").change(function(e) {

					var departName = $('#departLocation').find(":selected").text();	

					// if we already have an departure in the url but we have changed our mind we still need to process it		
					if(window.location.href.indexOf("Departure=") > -1)
					{
						var departNameNew = $('#departLocation').find(":selected").text();									
									  
						var url = window.location.toString();
						var splitUrl = url.split("Departure=");
							console.log("in depart url: " + splitUrl[1]);
							console.log("in depart Name New: " + departNameNew);
							console.log("in depart Name: " + departNameNew);
						
						
						if(splitUrl[1].search(departNameNew) == -1)
						{		
							console.log("search found it");
							var data=window.location+"Departure="+departName;
							window.location.replace("Departure="+departNameNew, "Departure="+departName);
						}
					}
					
					// pages is fresh with no departures previously selected so lets process that	
					else
					{

						
						var departNameNew = $('#departLocation').find(":selected").text();			
						if(departNameNew != "--")
						{			
							var data=window.location+"Departure="+departNameNew;
							window.location.replace(data);
						}
	
					}
					
			// important so that this function doesn't just run once
			if(e.originalEvent) {
				window.location.assign();
			}
			}).change();

		
		// checks if departure options has changed and we then parse that information into the url for flask to deal with form rendering
		$("#arriveLocation").change(function(e) {

					var arriveName = $('#arriveLocation').find(":selected").text();	


					
					
										// if we already have an departure in the url but we have changed our mind we still need to process it		
					if(window.location.href.indexOf("&Arrival=") > -1)
					{
						var arriveNameNew = $('#arriveLocation').find(":selected").text();	
								
									  
						var url = window.location.toString();
						var splitUrl = url.split("&Arrival=");

						
						
						if(splitUrl[1].search(arriveNameNew) == -1)
						{		
							var data=window.location.href+"&Arrival="+arriveName;
							window.location.replace(splitUrl[0]+"&Arrival="+arriveNameNew, "&Arrival="+arriveName);
						}
					}
					
					
					// pages is fresh with no departures previously selected so lets process that	
					else
					{
				

						var arriveNameNew = $('#arriveLocation').find(":selected").text();			
						if(arriveNameNew != "--")
						{			
							var data=window.location+"&Arrival="+arriveNameNew;
							window.location.replace(data);
							
						}
						
					}
					
			// important so that this function doesn't just run once
			if(e.originalEvent) {
				window.location.assign();
			}
			}).change();
		
		
		$("#passengerCnt").change(function(e) {
		
			// if we already have an arrival in the url but we have changed our mind we still need to process it		
			if(window.location.href.indexOf("&passCnt=") > -1)
			{
				var passCntNew = $('#passengerCnt').val();
				
				if(passCntNew != passCnt)
				{				
					var data=window.location.href+"&passCnt="+passCnt;
					//console.log("if url:" +window.location);
					var url = window.location.toString();
					var prevUrl = url.split("&passCnt");
					window.location.replace(prevUrl[0]+"&passCnt="+passCntNew, "&passCnt="+passCnt);
				}

			}
			// pages is fresh with no arrivals previously selected so lets process that
			else
			{
				var passCntNew = $('#passengerCnt').val();
				console.log(passCntNew);
				if(passCntNew != passCnt)
				{			
					var data=window.location+"&passCnt="+passCntNew;
					window.location.replace(data);
				}
			}
		
			// important so that this function doesn't just run once
			if(e.originalEvent) {
			
				window.location.assign();
			}
		}).change();
		
		$("#departTime").change(function(e) {
					
								console.log("detected change in time");

			var dtimeNew = $('#departTime').val();

			if(window.location.href.indexOf("&Time=") > -1)
			{

				if(dtimeNew != dtime)
					{				
						var data=window.location.href+"&Time="+dtimeNew;
						//console.log("if url:" +window.location);
						var url = window.location.toString();
						var prevUrl = url.split("&Time=");
						window.location.replace(prevUrl[0]+"&Time="+dtimeNew, "&Time="+dtime);
								
					
					}
			}
			else if(dtimeNew != "--")
			{
				console.log("in else of time");
					

						var departTimeNew = $('#departTime').find(":selected").text();
			
						var data=window.location+"&Time="+departTimeNew;
						window.location.replace(data);					
				
			}
				
				
			// important so that this function doesn't just run once
			if(e.originalEvent) {
			
				window.location.assign();
			}
		}).change();

		
	$('input[type="date"]').change(function(e){
        console.log("date is:" + this.value);         //Date in full format alert(new Date(this.value));
        console.log("default date is:" + {{form.departDateDefault}});         //Date in full format alert(new Date(this.value));
        var inputDate = new Date(this.value);
		
		var pickedDate = this.value;
		
		if(window.location.href.indexOf("&Date=") > -1)
			{

				/*if(dtimeNew != dtime)
					{*/				
				var data=window.location.href+"&Date="+pickedDate;
					//console.log("if url:" +window.location);
					var url = window.location.toString();
					var prevUrl = url.split("&Date=");
					window.location.replace(prevUrl[0]+"&Date="+pickedDate, "&Date="+pickedDate);
				
											window.location.assign();

					/*
					}*/
			}
			else if(pickedDate != null)
			{
				console.log("in else of date");
					//document.getElementById("journeyTime").removeAttribute("hidden");
						

						var departDateNew = pickedDate;
			
						var data=window.location+"&Date="+pickedDate;
						window.location.replace(data);					
								window.location.assign();

			}
		
				// important so that this function doesn't just run once
			//if(e.originalEvent) {
			
			//}
		
    });
	
				

	//
	});  // End Doc ready
	

		// space for our javascript functions below, we will prob move this to its own file when it gets bigger
			function initPage(){


									
					var CssDebug = false; // turn off and on as you please

					if(CssDebug){    
									//Cache Buster
						(function (){
						  var rep = /.*\?.*/,
							  links = document.getElementsByTagName('link'),
							  scripts = document.getElementsByTagName('script'),
							  process_scripts = false;
						  for (var i=0;i<links.length;i++){
							var link = links[i],
								href = link.href;
							if(rep.test(href)){
							  link.href = href+'&'+Date.now();
							}
							else{
							  link.href = href+'?'+Date.now();
							}

						  }
						  if(process_scripts){
							for (var i=0;i<scripts.length;i++){
							  var script = scripts[i],
								  src = script.src;
							  if(rep.test(src)){
								script.src = src+'&'+Date.now();
							  }
							  else{
								script.src = src+'?'+Date.now();
							  }

							}
						  }
						})();
					}
					
					
					
						// turn off depart time and arrivals until we check if we need to re-enable them
						document.getElementById("departTime").setAttribute("disabled",true);
						document.getElementById("arriveLocation").setAttribute("disabled",true);
						document.getElementById("submitBookingBtn").setAttribute("disabled",true);
						
						var departName = $('#departLocation').find(":selected").text();
						var arriveName = $('#arriveLocation').find(":selected").text();
						var departTimeValueOrig =  $('#departTime').find(":selected").text();
						var departDateValueOrig =  $('#departDate').find(":selected").text();
						
					// basically the goal here was to keep our selections in arrival/departure after the page
					// currently broken after fixing url changing issues, need to rework this, but its an style thing really so later
		/*				
						if(window.location.href.indexOf("Departure=") > -1)
						{
							var departDropList = document.getElementById("departLocation")
							//departDropList.remove(0); 
							for(var x=0;x < departDropList.length -1 ; x++)
							{
							   //if(departName == departDropList.options[x].text)
							   var url1 = window.location.toString();
							   var url = url1.split('Departure='); 
							   if (url[1].search(departDropList.options[x].text) != -1)
							   {
									departDropList.selectedIndex = x;
							   }
							}
							
								if(window.location.href.indexOf("&Arrival=") > -1)
								{
								
									var departDropList = document.getElementById("departLocation")
									//departDropList.remove(0); 
									for(var x=0;x < departDropList.length -1 ; x++)
									{
									   //if(departName == departDropList.options[x].text)
									   var url1 = window.location.toString();
									   var url = url1.split('Departure='); 
									   if (url[1].search(departDropList.options[x].text) != -1)
									   {
											departDropList.selectedIndex = x;
									   }
									}
								
									var arriveDropList = document.getElementById("arriveLocation")
									//arriveDropList.remove(0); 
									for(var x=0;x < arriveDropList.length -1 ; x++)
									{
									   //if(departName == arriveDropList.options[x].text)
									  var url2 = window.location.toString();
									  var url = url2.split('&Arrival='); 
									  if (url[1].search(arriveDropList.options[x].text) != -1)
									  {
											arriveDropList.selectedIndex = x;
									  }
									}
								}
						}
					
	
*/
						// we need to removed the disabled attribute from input fields once we have a depart location
						// that way we can then calculate times/dates
						// having these fields open will just make more work for us / make it confusing to the customer
						
						var location = window.location.href; // pull url into a string to check with

						// ok now that we have selected a departure which shows in the url we can enable arrival selection

						if(location.indexOf("Departure") > -1) {
						
							var departuresList = document.getElementById("departLocation");
							departuresList.remove(0); 
							
							document.getElementById("arriveLocation").removeAttribute("disabled");

						}
						
						// now that we have both an arrival and departure(arrival will only be in url if departure is)
						// we can enabled depart data/time now loaded with data from the database(in good time)
						
						if(location.indexOf("Arrival") > -1) {
							document.getElementById("departDate").removeAttribute("disabled");
							document.getElementById("departTime").removeAttribute("disabled");
							document.getElementById("passengerCnt").removeAttribute("disabled");
							
							var arrivalsList = document.getElementById("arriveLocation");
							arrivalsList.remove(0); 
							
						}
						
						if(location.indexOf("Time") > -1) {

							document.getElementById("journeyTime").removeAttribute("hidden");

							var departTimeList = document.getElementById("departTime")
							departTimeList.remove(0); 	
						}
						
						var passengerCount = document.getElementById("passengerCnt").value
						if((location.indexOf("passCnt") > -1) && passengerCount > 0){
							document.getElementById("bookPrice").removeAttribute("hidden");

							var departDateValue = document.getElementById ("departDate");
							departDateValue = departDateValue.value;
							var departTimeValue = document.getElementById ("departTime");
							departTimeValue = departTimeValue.value;

						
							console.log("orig date: " + departDateValueOrig);
							console.log("orig time: " + departTimeValueOrig);
							console.log("new date: " + departDateValue);
							console.log("new time: " + departTimeValue);

							if(
							( window.location.href.indexOf("&passCnt=") > -1)&&
							( window.location.href.indexOf("&Date=") > -1)&&
							( window.location.href.indexOf("&Time=") > -1))
							{
								document.getElementById("submitBookingBtn").removeAttribute("disabled");
							}
						}

					}	
					
			// our ui handlers to trigger flask app routing
			function plane(){
						window.location.replace("../plane");
					}
					
			function train(){
						window.location.replace("../train");

					}
					
			function bus(){
						window.location.replace("../bus");

					}
					
			function taxi(){

						window.location.replace("../taxi");
					}
					
			function ferry(){
						window.location.replace("../ferry");
					}
					
			function dateHandler(event){
				var departDateValuej = $('#departDate').find(":selected").text();

				console.log("depart date selected: "+ departDateValuej);
				// important so that this function doesn't just run once
				/*if(e.originalEvent) {
				
					window.location.assign();
			}*/
		}
</script>

</head>
<body>


<div class="wrapper w24 h24"> <!-- wrapper -->
	<div class="wrapperCont w24 h24">
		<!--<div class="col w24 h1 socBar"></div> <!-- social links -->
		<div class="col w24 h7"> <!-- banner logo space -->
			<!-- banner logo -->
			<div class="col w12 h20 grey"><img class="bannerLogo" src="{{ url_for('static', filename='assets/grandTravellogo.jpg') }}" height="125%" width="100%" style="z-index:0; position:absolute; bottom:-25%; "></div>
			<!-- banner text -->
			<div class="col w12 h20 banner invert white">
				<!--<img class="bannerLogo" style="float:left;">-->
				Grand Travel
			</div>
		
		
			<div class="col w24 h4 nav" style="z-index:1; position:relative; bottom:0;"><!-- navbar --> 
				<ul>
					<li class="col w4 h24 clear nohover"></a></li>
					<li class="col w3 h24 gtblue invert navButton" onclick="plane()">PLANE</a></li>
					<li class="col w3 h24 gtblue invert navButton" onclick="train()">TRAIN</a></li>
					<li class="col w3 h24 gtblue invert navButton" onclick="bus()">BUS</a></li>
					<li class="col w3 h24 gtblue invert navButton" onclick="taxi()">TAXI</a></li>
					<li class="col w3 h24 gtblue invert navButton" onclick="ferry()">FERRY</a></li>
					<li class="col w5 h24 white nohover"></a></li>
				</ul>			
			</div>
		</div> 
		<div class="col w24 h17 black "><!-- slidshow --> 
			<!-- div holding left slideshow arrow -->
			<!--<div class="col w4 h24 black arrow" onclick="backImage()"></div>-->
			<!-- main slideshow window -->
			<div class="col w24 h24 slideshowContainer fade">					
				<div style=" height: 100%">
					<!-- slideshow 1st image placeholder -->
					<div style="width: 100%; height: 100%; position: relative; color:white; background-color:black;  border-top: 1px solid #fff;">
							<!-- working area for dynamic forms based on the database data using jinja to pull and flask to feed -->
							<form method=post style="position: absolute; padding:10%; width:100%; height:100%; z-index: 1; margin-left: 20%; margin-right:20%; ">
							<label for="party">Choose your Departure location:</label><br>	
								{{ form.departLocation.__call__(**{'class': 'form-control'}) }}<br>
							
							<!-- greyed out until a departure is selected, too much irrelevant information to process -->
							<label for="party">Choose your Arrival location:</label><br>	
								{{ form.arriveLocation.__call__(**{'class': 'form-control'}) }}<br>
		
							<!-- after this our form is greyed out until we have both an arrival and departure selected, then our flask app will tell us what options are available-->
							<label for="party">How many are traveling:</label><br>
							<label for="party">Adult:</label>							
							<input type="number" id="passengerCnt" min={{form.passCntMin}} max={{ form.passCntMax }} value={{ form.passCnt}} disabled>
							<label for="party">Child:</label>							
							<input type="number" id="passengerCntChild" min={{form.passCntMin}} max={{ form.passCntMax }} value={{ form.passCnt}} disabled><br>
							<label for="party">Choose your Departure time:</label><br>
								{{ form.departTime.__call__(**{'class': 'form-control'}) }}<br>
							<label for="party">Choose your Departure Date:</label><br>
							<input type="date" id="departDate" min={{form.departDateMin}} max={{form.departDateMax}} value={{form.departDateDefault}} onchange="dateHandler(event);" disabled><br><br>
							<!-- our booking confirm button for later that will trigger a model to process payment -->
							<button id="submitBookingBtn" disabled type=submit>Book!</button>
							<p id="bookPrice" hidden>Booking Price: {{ bookingPrice }}</p>
							<p id="journeyTime" hidden>Estimated Journey Time: {{ form.journeyTime }}</p>
							</form>
						<!-- dynamically change slideImage passed in as a variable to render our page -->												
						<img id="slideshow" src="/static/assets/{{ slideImage }}" width="100%" height="100%" style="position: absolute; z-index:0; opacity: 0.5; ">
					</div>

					<!--<img id="slideshow" src="" />-->
				</div>
			</div> 					
			<!-- div holding right slideshow arrow -->
			<!--<div id="right" class="col w4 h24 black arrow" onclick="slideImage()" style="float:right;"></div> -->	
		</div><!-- end of slideshow window -->
		
		<!-- include bottom navigation -->
	</div>
</div> <!-- end of panel wrap -->

<!-- |Hidden Panels below here -->


</body>
</html>